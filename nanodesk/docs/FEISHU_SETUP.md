# 飞书机器人配置指南

## 概述

飞书机器人适合国内用户，每月 10000 次 API 调用额度，轻度个人使用完全够用。

## 一、创建飞书机器人

### 步骤 1：登录飞书开放平台

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 用飞书 APP 扫码登录

### 步骤 2：创建企业自建应用

1. 点击「应用开发」→「企业自建应用」→「创建应用"
2. 填写应用信息：
   - **应用名称**：`Nanodesk`（或其他你喜欢的名字）
   - **应用描述**：`个人 AI 助手`
   - **应用图标**：上传任意图片（可选）
3. 点击「确定创建"

### 步骤 3：获取凭证

1. 进入应用详情页 →「凭证与基础信息"
2. 复制以下信息：
   - **App ID**（格式：`cli_xxxxxxxx`）
   - **App Secret**（点击「查看」复制）

### 步骤 4：开启机器人能力

1. 左侧菜单 →「机器人"
2. 点击「启用机器人"
3. 设置：
   - **显示名称**：`AI 助手`（用户看到的名字）
   - **描述**：`个人智能助手`

> ⚠️ **注意**：必须看到「已启用」状态，且左侧菜单有「机器人」选项才算成功

### 步骤 5：配置权限（关键！）

1. 左侧菜单 →「权限管理"
2. 点击「批量开通权限」或「开通权限"
3. 搜索并添加以下权限（全部必须）：

| 权限名称 | 权限代码 | 用途 |
|---------|---------|------|
| 以应用的身份发消息 | `im:message:send_as_bot` | 发送消息 |
| 读取用户发给机器人的单聊消息 | `im:message.p2p_msg:readonly` | 接收私聊 |
| 获取群组中所有消息 | `im:message.group_msg` | 接收群消息 |
| 接收群聊中@机器人消息事件 | `im:message.group_at_msg:readonly` | 接收@消息 |
| 订阅访问机器人会话相关事件 | `im:chat.access_event.bot_p2p_chat:read` | 会话事件 |

> 💡 **提示**：搜索关键词 `im:message` 可以快速找到相关权限

### 步骤 6：配置事件订阅（关键！）

1. 左侧菜单 →「事件与回调"
2. 点击「订阅方式」旁边的编辑图标（✏️）
3. 选择：**「使用长连接接收事件」**（WebSocket 模式）
4. 点击「保存"

> ⚠️ **注意**：
> - 如果保存按钮点不了，先确保步骤 5 的权限已开通
> - 权限和订阅方式有依赖关系，必须先开权限再配订阅

5. 点击「添加事件"，添加以下事件：

| 事件 | 事件代码 | 必须 |
|------|---------|------|
| 接收消息 | `im.message.receive_v1` | ✅ 必须有 |
| 机器人入群 | `im.chat.member.bot.added_v1` | 可选 |

> 💡 **提示**：事件配置变更后必须重新发布应用才能生效

### 步骤 7：发布应用

1. 左侧菜单 →「版本管理与发布"
2. 点击「创建版本"
3. 填写：
   - **版本号**：`1.0.0`（首次）或递增（如 `1.0.1`）
   - **更新说明**：`初始版本` 或具体更新内容
4. 点击「保存」→「申请发布"
5. 点击「确认发布"（个人应用无需审核）

> ⚠️ **重要**：每次修改权限、事件配置后，都需要**重新发布**新版本！

### 步骤 8：添加机器人到聊天

**方式 A：私聊（推荐）**
1. 在飞书 APP 顶部搜索框输入**机器人名字**（如 `Nado`）
   - 💡 **注意**：直接搜名字即可，**不需要加 @**
   - 搜索结果会显示为「**应用**」类型，这是正常的
2. 点击搜索结果进入详情页
3. 点击「**开始使用**」或「**创建新聊天**"

**方式 B：从工作台进入**
1. 飞书 APP 底部「**工作台**」标签
2. 找到「**自建应用**」区域
3. 点击你的机器人图标进入聊天

**方式 C：群聊**
1. 进入任意群聊 → 点击右上角「···」→「设置"
2. 点击「机器人」→「添加机器人"
3. 搜索你的机器人名字，点击添加

> 💡 **验证**：能打开聊天窗口并发送消息（无红色感叹号）即表示添加成功
> 
> 💡 **提示**：搜索结果显示为「**应用**」而非「**机器人**」是正常的，点击即可使用

## 二、配置 Nanodesk

### 编辑配置文件

打开 `C:\Users\<用户名>\.nanobot\config.json`，添加飞书配置：

```json
{
  "agents": {
    "defaults": {
      "workspace": "D:/Nanodesk/workspace",
      "model": "dashscope/qwen-plus",
      "max_tokens": 4096,
      "temperature": 0.7
    }
  },
  "providers": {
    "dashscope": {
      "api_key": "sk-xxxxxxxx"
    }
  },
  "channels": {
    "feishu": {
      "enabled": true,
      "app_id": "cli_xxxxxxxx",
      "app_secret": "xxxxxxxxxxxxxxxx",
      "allow_from": []
    }
  },
  "tools": {
    "restrict_to_workspace": true
  }
}
```

### 配置说明

| 字段 | 说明 | 必填 |
|------|------|------|
| `enabled` | 是否启用飞书频道 | ✅ |
| `app_id` | 飞书应用的 App ID（cli_开头） | ✅ |
| `app_secret` | 飞书应用的 App Secret | ✅ |
| `allow_from` | 允许的用户 OpenID 列表，空数组表示允许所有人 | 可选 |

## 三、启动测试

### 方式 1：命令行启动

```powershell
# 激活虚拟环境（如果未激活）
.venv\Scripts\Activate.ps1

# 启动网关（后台服务，监听飞书消息）
nanodesk gateway --verbose
```

看到以下日志表示成功：
```
🔧 Loading Nanodesk customization...
✅ Nanodesk customization loaded
INFO - Feishu channel enabled
INFO - Feishu bot started with WebSocket long connection
```

### 方式 2：VS Code 调试

1. `Ctrl+Shift+D` 打开调试面板
2. 选择「Nanodesk Gateway"
3. 按 `F5` 启动

## 四、测试机器人

### 私聊测试

1. 在飞书 APP 搜索框输入 `@你的机器人名字`
2. 进入私聊，发送：`你好`
3. 等待 AI 回复（首次可能 3-5 秒）

### 群聊测试

1. 在群里 `@你的机器人 你好`
2. 机器人会回复你

> 💡 **提示**：如果机器人不回复，查看下方的故障排查

## 五、故障排查

### 问题 1：能搜到机器人但无法聊天

**现象**：飞书里搜到应用，但没有「开始聊天」按钮，或发送消息有红色感叹号

**原因**：
- 未启用机器人能力
- 应用未发布
- 未添加消息权限

**解决**：
1. 检查「机器人」菜单是否显示「已启用"
2. 检查「权限管理」是否开通了 `im:message:send_as_bot`
3. 检查「版本管理与发布」是否已发布

### 问题 2：Nanodesk 启动正常但收不到消息

**现象**：日志显示 `Feishu bot started`，但发消息没有反应

**原因**：
- 未配置事件订阅
- 未添加 `im.message.receive_v1` 事件
- 修改后未重新发布

**解决**：
1. 检查「事件与回调」→「订阅方式」是否为「长连接"
2. 检查「已添加事件」是否有 `im.message.receive_v1`
3. **重新发布应用**（关键！）

### 问题 3：订阅方式保存不了

**现象**：点击订阅方式保存没有反应

**原因**：权限未开通，订阅方式依赖权限

**解决**：
1. 先开通步骤 5 的所有权限
2. 刷新页面
3. 再配置订阅方式

### 问题 4：修改配置后仍不生效

**现象**：改了权限/事件，但还是收不到消息

**原因**：飞书配置变更后必须重新发布才能生效

**解决**：
1. 「版本管理与发布」→「创建版本"
2. 版本号递增（如 `1.0.0` → `1.0.1`）
3. 保存并发布
4. 等待 1-2 分钟后测试

### 查看日志

如果以上都不奏效，查看详细日志：

```powershell
# PowerShell
$env:LOGURU_LEVEL = "DEBUG"
nanodesk gateway
```

看是否有：
- `Feishu WebSocket connected` - 连接成功
- `im.message.receive_v1` - 收到消息事件
- 错误信息

## 六、限额监控

每月关注 API 使用情况：

1. 登录 [飞书开放平台](https://open.feishu.cn/)
2. 进入你的应用 →「运营监控」→「API 调用统计"
3. 查看调用量

**提示**：
- 每月 1 号 00:00 自动重置 10000 次额度
- 个人轻度使用完全够用（约 600-800 次对话）

## 七、安全建议

1. **不要分享 App Secret**：相当于密码，泄露后别人可以控制你的机器人
2. **配置 allow_from**（可选）：生产环境建议限制特定用户
   ```json
   "allow_from": ["ou_xxxxxxxx", "ou_yyyyyyyy"]
   ```
3. **定期更换 Secret**：如果发现异常调用，在后台重置 Secret

## 参考

- [飞书开放平台文档](https://open.feishu.cn/document/home/index)
- [飞书机器人开发指南](https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/im-v1/message/introduction)
- [API 调用限额说明](https://open.feishu.cn/document/ukTMukTMukTM/uMTN1YjLzUTN24yM1UjN)
